<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Concurrency on Terminal</title><link>https://strajabot.com/tags/concurrency/</link><description>Recent content in Concurrency on Terminal</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Mon, 19 Feb 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://strajabot.com/tags/concurrency/index.xml" rel="self" type="application/rss+xml"/><item><title>RISC-V: Managing concurrency using spinlocks</title><link>https://strajabot.com/posts/kernel-concurrency-riscv/</link><pubDate>Mon, 19 Feb 2024 00:00:00 +0000</pubDate><guid>https://strajabot.com/posts/kernel-concurrency-riscv/</guid><description>Why do we need synchronization? When coding a multicore operating system, to minimize overhead associated with executing system calls, we want to be able to run kernel code on multiple cores at the same time. To do this correctly, we need to solve the critical section problem, a problem that arises frequently when implementing a multiprocessor, preemptive kernel.
To illustrate the critical section problem, we will take a close look at a memory allocator for fixed size blocks.</description><content>&lt;h2 id="why-do-we-need-synchronization">Why do we need synchronization?&lt;/h2>
&lt;p>When coding a multicore operating system, to minimize overhead associated with executing system calls, we want to be able to run kernel code on multiple cores at the same time. To do this correctly, we need to solve the critical section problem, a problem that arises frequently when implementing a multiprocessor, preemptive kernel.&lt;/p>
&lt;p>To illustrate the critical section problem, we will take a close look at a memory allocator for fixed size blocks. This allocator will function by keeping track of free blocks by keeping them inside a linked list.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> free_block {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> free_block&lt;span style="color:#f92672">*&lt;/span> next
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> free_block&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">volatile&lt;/span> head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#a6e22e">alloc_block&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span> block &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>) head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> head &lt;span style="color:#f92672">=&lt;/span> head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> block;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>When we think about it, the compiled version of the code above could look like:&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-riscvasm" data-lang="riscvasm">alloc_block:
ld a0, head #a0 &amp;lt;- head
ld a1, 0(a0) #a1 &amp;lt;- head-&amp;gt;next
sd a1, head #head &amp;lt;- a1
ret #return value is in a0
&lt;/code>&lt;/pre>&lt;p>Since &lt;code>alloc_block&lt;/code> can be executing on multiple processor cores and we haven&amp;rsquo;t implemented any synchronization, the following situation can occur:&lt;/p>
&lt;pre tabindex="0">&lt;code>// INITIAL VALUES
head = 0x1000;
head-&amp;gt;next = 0x2000;
&lt;/code>&lt;/pre>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>TIME&lt;/th>
&lt;th>THREAD 1 (ON CORE 1)&lt;/th>
&lt;th>THREAD 2 (ON CORE 2)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1.&lt;/td>
&lt;td>ld a0, head [head=0x1000]&lt;/td>
&lt;td>?&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2.&lt;/td>
&lt;td>ld a1, 0(a0) [head-&amp;gt;next=0x2000]&lt;/td>
&lt;td>ld a0, head [head=0x1000]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3.&lt;/td>
&lt;td>/&lt;/td>
&lt;td>ld a1, 0(a0) [head-&amp;gt;next=0x2000]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4.&lt;/td>
&lt;td>sd a1, head [head=0x2000]&lt;/td>
&lt;td>/&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5.&lt;/td>
&lt;td>ret [return a0=0x1000]&lt;/td>
&lt;td>sd a1, head [head=0x2000]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>6.&lt;/td>
&lt;td>?&lt;/td>
&lt;td>ret [return a0=0x1000]&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>If we look closely at the return value, we realize that both threads have allocated the same block, which is not correct behavior because now both threads are sharing a block that they believe to have exclusive access to. Mistakes like this inside the kernel can cause catastrophic failures of user code and the operating system, depending on what the allocated memory is used for.&lt;/p>
&lt;p>The issue in this code arises from the fact that changing the head of the list is not an atomic operation, leading to THREAD 2 being able to read the old head value before THREAD 1 gets to update it by storing the new value.&lt;/p>
&lt;p>To find a solution to this problem, we will think about the correct behavior. The correct behavior is that once either of the threads starts the operation by executing &lt;code>void* block = (void*) head;&lt;/code> no other threads can start executing the operation until the thread that started the operation finishes executing &lt;code>head = head-&amp;gt;next;&lt;/code>. This way it is impossible for threads to read the old value of &lt;code>head&lt;/code>.&lt;/p>
&lt;p>So, for the code to behave correctly, it needs to &lt;em>lock&lt;/em> the &lt;em>section&lt;/em> before starting the operation, and it needs to &lt;em>unlock&lt;/em> the &lt;em>section&lt;/em> when it finishes the operation so that other threads can start their operations.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> free_block {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">struct&lt;/span> free_block&lt;span style="color:#f92672">*&lt;/span> next
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> section;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> free_block&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#66d9ef">volatile&lt;/span> head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#a6e22e">alloc_block&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">lock&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>section);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span> block &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>) head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> head &lt;span style="color:#f92672">=&lt;/span> head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">unlock&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>section);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> block;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We now need to implement &lt;code>lock&lt;/code> and &lt;code>unlock&lt;/code> .&lt;/p>
&lt;h2 id="void-lockint-section">&lt;code>void lock(int* section);&lt;/code>&lt;/h2>
&lt;div class="goat svg-container ">
&lt;svg
xmlns="http://www.w3.org/2000/svg"
font-family="Menlo,Lucida Console,monospace"
viewBox="0 0 472 329"
>
&lt;g transform='translate(8,16)'>
&lt;path d='M 16,0 L 112,0' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,32 L 64,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,32 L 112,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 72,48 L 176,48' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 216,48 L 240,48' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 120,96 L 176,96' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 240,128 L 264,128' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,176 L 120,176' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,208 L 120,208' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 216,224 L 240,224' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,272 L 120,272' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,304 L 120,304' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 20,72 L 64,72' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,72 L 108,72' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 20,120 L 108,120' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,176 L 8,208' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,272 L 8,304' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,0 L 16,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,32 L 64,64' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,128 L 64,160' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,224 L 64,256' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 112,0 L 112,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 120,176 L 120,208' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 120,272 L 120,304' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 176,48 L 176,96' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 240,48 L 240,128' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 240,128 L 240,224' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,96 L 20,72' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 108,120 L 120,96' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,96 L 20,120' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 108,72 L 120,96' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,120 L 64,128' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,216 L 64,224' fill='none' stroke='currentColor'>&lt;/path>
&lt;polygon points='72.000000,64.000000 60.000000,58.400002 60.000000,69.599998' fill='currentColor' transform='rotate(90.000000, 64.000000, 64.000000)'>&lt;/polygon>
&lt;path d='M 64,160 L 64,168' fill='none' stroke='currentColor'>&lt;/path>
&lt;polygon points='80.000000,160.000000 68.000000,154.399994 68.000000,165.600006' fill='currentColor' transform='rotate(90.000000, 64.000000, 160.000000)'>&lt;/polygon>
&lt;path d='M 64,256 L 64,264' fill='none' stroke='currentColor'>&lt;/path>
&lt;polygon points='80.000000,256.000000 68.000000,250.399994 68.000000,261.600006' fill='currentColor' transform='rotate(90.000000, 64.000000, 256.000000)'>&lt;/polygon>
&lt;polygon points='80.000000,48.000000 68.000000,42.400002 68.000000,53.599998' fill='currentColor' transform='rotate(180.000000, 72.000000, 48.000000)'>&lt;/polygon>
&lt;polygon points='272.000000,128.000000 260.000000,122.400002 260.000000,133.600006' fill='currentColor' transform='rotate(0.000000, 264.000000, 128.000000)'>&lt;/polygon>
&lt;text text-anchor='middle' x='0' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='100' fill='currentColor' style='font-size:1em'>s&lt;/text>
&lt;text text-anchor='middle' x='24' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='196' fill='currentColor' style='font-size:1em'>s&lt;/text>
&lt;text text-anchor='middle' x='24' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='100' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='32' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='196' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='32' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='100' fill='currentColor' style='font-size:1em'>c&lt;/text>
&lt;text text-anchor='middle' x='40' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='196' fill='currentColor' style='font-size:1em'>c&lt;/text>
&lt;text text-anchor='middle' x='40' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='20' fill='currentColor' style='font-size:1em'>L&lt;/text>
&lt;text text-anchor='middle' x='48' y='100' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='48' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='196' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='48' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='20' fill='currentColor' style='font-size:1em'>O&lt;/text>
&lt;text text-anchor='middle' x='56' y='100' fill='currentColor' style='font-size:1em'>i&lt;/text>
&lt;text text-anchor='middle' x='56' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='196' fill='currentColor' style='font-size:1em'>i&lt;/text>
&lt;text text-anchor='middle' x='56' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='292' fill='currentColor' style='font-size:1em'>R&lt;/text>
&lt;text text-anchor='middle' x='64' y='20' fill='currentColor' style='font-size:1em'>C&lt;/text>
&lt;text text-anchor='middle' x='64' y='100' fill='currentColor' style='font-size:1em'>o&lt;/text>
&lt;text text-anchor='middle' x='64' y='196' fill='currentColor' style='font-size:1em'>o&lt;/text>
&lt;text text-anchor='middle' x='64' y='292' fill='currentColor' style='font-size:1em'>E&lt;/text>
&lt;text text-anchor='middle' x='72' y='20' fill='currentColor' style='font-size:1em'>K&lt;/text>
&lt;text text-anchor='middle' x='72' y='100' fill='currentColor' style='font-size:1em'>n&lt;/text>
&lt;text text-anchor='middle' x='72' y='196' fill='currentColor' style='font-size:1em'>n&lt;/text>
&lt;text text-anchor='middle' x='72' y='292' fill='currentColor' style='font-size:1em'>T&lt;/text>
&lt;text text-anchor='middle' x='80' y='148' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='80' y='244' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='88' y='100' fill='currentColor' style='font-size:1em'>=&lt;/text>
&lt;text text-anchor='middle' x='88' y='148' fill='currentColor' style='font-size:1em'>r&lt;/text>
&lt;text text-anchor='middle' x='88' y='196' fill='currentColor' style='font-size:1em'>=&lt;/text>
&lt;text text-anchor='middle' x='88' y='244' fill='currentColor' style='font-size:1em'>r&lt;/text>
&lt;text text-anchor='middle' x='96' y='148' fill='currentColor' style='font-size:1em'>u&lt;/text>
&lt;text text-anchor='middle' x='96' y='244' fill='currentColor' style='font-size:1em'>u&lt;/text>
&lt;text text-anchor='middle' x='104' y='100' fill='currentColor' style='font-size:1em'>0&lt;/text>
&lt;text text-anchor='middle' x='104' y='148' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='104' y='196' fill='currentColor' style='font-size:1em'>1&lt;/text>
&lt;text text-anchor='middle' x='104' y='244' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='128' y='84' fill='currentColor' style='font-size:1em'>f&lt;/text>
&lt;text text-anchor='middle' x='136' y='84' fill='currentColor' style='font-size:1em'>a&lt;/text>
&lt;text text-anchor='middle' x='144' y='84' fill='currentColor' style='font-size:1em'>l&lt;/text>
&lt;text text-anchor='middle' x='152' y='84' fill='currentColor' style='font-size:1em'>s&lt;/text>
&lt;text text-anchor='middle' x='160' y='84' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='280' y='132' fill='currentColor' style='font-size:1em'>M&lt;/text>
&lt;text text-anchor='middle' x='288' y='132' fill='currentColor' style='font-size:1em'>u&lt;/text>
&lt;text text-anchor='middle' x='296' y='132' fill='currentColor' style='font-size:1em'>s&lt;/text>
&lt;text text-anchor='middle' x='304' y='132' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='320' y='132' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='328' y='132' fill='currentColor' style='font-size:1em'>x&lt;/text>
&lt;text text-anchor='middle' x='336' y='132' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='344' y='132' fill='currentColor' style='font-size:1em'>c&lt;/text>
&lt;text text-anchor='middle' x='352' y='132' fill='currentColor' style='font-size:1em'>u&lt;/text>
&lt;text text-anchor='middle' x='360' y='132' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='368' y='132' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='384' y='132' fill='currentColor' style='font-size:1em'>a&lt;/text>
&lt;text text-anchor='middle' x='392' y='132' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='400' y='132' fill='currentColor' style='font-size:1em'>o&lt;/text>
&lt;text text-anchor='middle' x='408' y='132' fill='currentColor' style='font-size:1em'>m&lt;/text>
&lt;text text-anchor='middle' x='416' y='132' fill='currentColor' style='font-size:1em'>i&lt;/text>
&lt;text text-anchor='middle' x='424' y='132' fill='currentColor' style='font-size:1em'>c&lt;/text>
&lt;text text-anchor='middle' x='432' y='132' fill='currentColor' style='font-size:1em'>a&lt;/text>
&lt;text text-anchor='middle' x='440' y='132' fill='currentColor' style='font-size:1em'>l&lt;/text>
&lt;text text-anchor='middle' x='448' y='132' fill='currentColor' style='font-size:1em'>l&lt;/text>
&lt;text text-anchor='middle' x='456' y='132' fill='currentColor' style='font-size:1em'>y&lt;/text>
&lt;/g>
&lt;/svg>
&lt;/div>
&lt;h2 id="void-unlockint-section">&lt;code>void unlock(int* section);&lt;/code>&lt;/h2>
&lt;div class="goat svg-container ">
&lt;svg
xmlns="http://www.w3.org/2000/svg"
font-family="Menlo,Lucida Console,monospace"
viewBox="0 0 480 249"
>
&lt;g transform='translate(8,16)'>
&lt;path d='M 16,0 L 112,0' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,32 L 64,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,32 L 112,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,96 L 120,96' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,128 L 120,128' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,192 L 120,192' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,224 L 120,224' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,96 L 8,128' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,192 L 8,224' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,0 L 16,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,32 L 64,80' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,144 L 64,176' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 112,0 L 112,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 120,96 L 120,128' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 120,192 L 120,224' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,136 L 64,144' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,80 L 64,88' fill='none' stroke='currentColor'>&lt;/path>
&lt;polygon points='80.000000,80.000000 68.000000,74.400002 68.000000,85.599998' fill='currentColor' transform='rotate(90.000000, 64.000000, 80.000000)'>&lt;/polygon>
&lt;path d='M 64,176 L 64,184' fill='none' stroke='currentColor'>&lt;/path>
&lt;polygon points='80.000000,176.000000 68.000000,170.399994 68.000000,181.600006' fill='currentColor' transform='rotate(90.000000, 64.000000, 176.000000)'>&lt;/polygon>
&lt;text text-anchor='middle' x='0' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='116' fill='currentColor' style='font-size:1em'>s&lt;/text>
&lt;text text-anchor='middle' x='24' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='116' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='32' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='20' fill='currentColor' style='font-size:1em'>U&lt;/text>
&lt;text text-anchor='middle' x='40' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='116' fill='currentColor' style='font-size:1em'>c&lt;/text>
&lt;text text-anchor='middle' x='40' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='20' fill='currentColor' style='font-size:1em'>N&lt;/text>
&lt;text text-anchor='middle' x='48' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='116' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='48' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='20' fill='currentColor' style='font-size:1em'>L&lt;/text>
&lt;text text-anchor='middle' x='56' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='116' fill='currentColor' style='font-size:1em'>i&lt;/text>
&lt;text text-anchor='middle' x='56' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='212' fill='currentColor' style='font-size:1em'>R&lt;/text>
&lt;text text-anchor='middle' x='64' y='20' fill='currentColor' style='font-size:1em'>O&lt;/text>
&lt;text text-anchor='middle' x='64' y='116' fill='currentColor' style='font-size:1em'>o&lt;/text>
&lt;text text-anchor='middle' x='64' y='212' fill='currentColor' style='font-size:1em'>E&lt;/text>
&lt;text text-anchor='middle' x='72' y='20' fill='currentColor' style='font-size:1em'>C&lt;/text>
&lt;text text-anchor='middle' x='72' y='116' fill='currentColor' style='font-size:1em'>n&lt;/text>
&lt;text text-anchor='middle' x='72' y='212' fill='currentColor' style='font-size:1em'>T&lt;/text>
&lt;text text-anchor='middle' x='80' y='20' fill='currentColor' style='font-size:1em'>K&lt;/text>
&lt;text text-anchor='middle' x='80' y='68' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='88' y='68' fill='currentColor' style='font-size:1em'>r&lt;/text>
&lt;text text-anchor='middle' x='88' y='116' fill='currentColor' style='font-size:1em'>=&lt;/text>
&lt;text text-anchor='middle' x='96' y='68' fill='currentColor' style='font-size:1em'>u&lt;/text>
&lt;text text-anchor='middle' x='104' y='68' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='104' y='116' fill='currentColor' style='font-size:1em'>0&lt;/text>
&lt;/g>
&lt;/svg>
&lt;/div>
&lt;p>However for implementing &lt;code>lock&lt;/code> we must avoid any implementations that compile to LOAD -&amp;gt; BRANCH -&amp;gt; STORE because writing the &lt;code>lock&lt;/code> function like that will make it susceptible to the same problem we had in &lt;code>alloc_block&lt;/code>. To implement this behavior correctly we turn to atomic instructions.&lt;/p>
&lt;h2 id="amoswap-rd-rs2-rs1">&lt;code>amoswap rd, rs2, (rs1)&lt;/code>&lt;/h2>
&lt;p>&lt;code>amoswap&lt;/code> is an instruction from the A extension which allows us to swap the data from &lt;code>rs2 =&amp;gt; (rs1) =&amp;gt; rd&lt;/code> as a single atomic operation. Using this instruction we can implement &lt;code>lock&lt;/code> like so:&lt;/p>
&lt;div class="goat svg-container ">
&lt;svg
xmlns="http://www.w3.org/2000/svg"
font-family="Menlo,Lucida Console,monospace"
viewBox="0 0 360 409"
>
&lt;g transform='translate(8,16)'>
&lt;path d='M 16,0 L 112,0' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,32 L 64,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,32 L 112,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,80 L 112,80' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,112 L 112,112' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 72,144 L 296,144' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,176 L 256,176' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,208 L 64,208' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,208 L 256,208' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 120,272 L 296,272' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,352 L 120,352' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,384 L 120,384' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 20,248 L 64,248' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,248 L 108,248' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 20,296 L 108,296' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,352 L 8,384' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,0 L 16,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,80 L 16,112' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 16,176 L 16,208' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,32 L 64,64' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,128 L 64,160' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,208 L 64,240' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,304 L 64,336' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 112,0 L 112,32' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 112,80 L 112,112' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 120,352 L 120,384' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 256,176 L 256,208' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 296,144 L 296,272' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,272 L 20,248' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 108,296 L 120,272' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 8,272 L 20,296' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 108,248 L 120,272' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,120 L 64,128' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,296 L 64,304' fill='none' stroke='currentColor'>&lt;/path>
&lt;path d='M 64,64 L 64,72' fill='none' stroke='currentColor'>&lt;/path>
&lt;polygon points='80.000000,64.000000 68.000000,58.400002 68.000000,69.599998' fill='currentColor' transform='rotate(90.000000, 64.000000, 64.000000)'>&lt;/polygon>
&lt;path d='M 64,160 L 64,168' fill='none' stroke='currentColor'>&lt;/path>
&lt;polygon points='80.000000,160.000000 68.000000,154.399994 68.000000,165.600006' fill='currentColor' transform='rotate(90.000000, 64.000000, 160.000000)'>&lt;/polygon>
&lt;polygon points='72.000000,240.000000 60.000000,234.399994 60.000000,245.600006' fill='currentColor' transform='rotate(90.000000, 64.000000, 240.000000)'>&lt;/polygon>
&lt;path d='M 64,336 L 64,344' fill='none' stroke='currentColor'>&lt;/path>
&lt;polygon points='80.000000,336.000000 68.000000,330.399994 68.000000,341.600006' fill='currentColor' transform='rotate(90.000000, 64.000000, 336.000000)'>&lt;/polygon>
&lt;polygon points='80.000000,144.000000 68.000000,138.399994 68.000000,149.600006' fill='currentColor' transform='rotate(180.000000, 72.000000, 144.000000)'>&lt;/polygon>
&lt;text text-anchor='middle' x='0' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='0' y='324' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='244' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='8' y='324' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='16' y='324' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='24' y='324' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='100' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='32' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='196' fill='currentColor' style='font-size:1em'>a&lt;/text>
&lt;text text-anchor='middle' x='32' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='32' y='276' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='32' y='324' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='100' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='40' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='196' fill='currentColor' style='font-size:1em'>m&lt;/text>
&lt;text text-anchor='middle' x='40' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='40' y='276' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='40' y='324' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='20' fill='currentColor' style='font-size:1em'>L&lt;/text>
&lt;text text-anchor='middle' x='48' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='100' fill='currentColor' style='font-size:1em'>m&lt;/text>
&lt;text text-anchor='middle' x='48' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='196' fill='currentColor' style='font-size:1em'>o&lt;/text>
&lt;text text-anchor='middle' x='48' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='48' y='276' fill='currentColor' style='font-size:1em'>m&lt;/text>
&lt;text text-anchor='middle' x='48' y='324' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='20' fill='currentColor' style='font-size:1em'>O&lt;/text>
&lt;text text-anchor='middle' x='56' y='68' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='100' fill='currentColor' style='font-size:1em'>p&lt;/text>
&lt;text text-anchor='middle' x='56' y='148' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='164' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='196' fill='currentColor' style='font-size:1em'>s&lt;/text>
&lt;text text-anchor='middle' x='56' y='228' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='276' fill='currentColor' style='font-size:1em'>p&lt;/text>
&lt;text text-anchor='middle' x='56' y='324' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='56' y='372' fill='currentColor' style='font-size:1em'>R&lt;/text>
&lt;text text-anchor='middle' x='64' y='20' fill='currentColor' style='font-size:1em'>C&lt;/text>
&lt;text text-anchor='middle' x='64' y='196' fill='currentColor' style='font-size:1em'>w&lt;/text>
&lt;text text-anchor='middle' x='64' y='372' fill='currentColor' style='font-size:1em'>E&lt;/text>
&lt;text text-anchor='middle' x='72' y='20' fill='currentColor' style='font-size:1em'>K&lt;/text>
&lt;text text-anchor='middle' x='72' y='100' fill='currentColor' style='font-size:1em'>=&lt;/text>
&lt;text text-anchor='middle' x='72' y='196' fill='currentColor' style='font-size:1em'>a&lt;/text>
&lt;text text-anchor='middle' x='72' y='276' fill='currentColor' style='font-size:1em'>=&lt;/text>
&lt;text text-anchor='middle' x='72' y='372' fill='currentColor' style='font-size:1em'>T&lt;/text>
&lt;text text-anchor='middle' x='80' y='196' fill='currentColor' style='font-size:1em'>p&lt;/text>
&lt;text text-anchor='middle' x='80' y='324' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='88' y='100' fill='currentColor' style='font-size:1em'>1&lt;/text>
&lt;text text-anchor='middle' x='88' y='276' fill='currentColor' style='font-size:1em'>0&lt;/text>
&lt;text text-anchor='middle' x='88' y='324' fill='currentColor' style='font-size:1em'>r&lt;/text>
&lt;text text-anchor='middle' x='96' y='196' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='96' y='324' fill='currentColor' style='font-size:1em'>u&lt;/text>
&lt;text text-anchor='middle' x='104' y='196' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='104' y='324' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='112' y='196' fill='currentColor' style='font-size:1em'>m&lt;/text>
&lt;text text-anchor='middle' x='120' y='196' fill='currentColor' style='font-size:1em'>p&lt;/text>
&lt;text text-anchor='middle' x='128' y='196' fill='currentColor' style='font-size:1em'>,&lt;/text>
&lt;text text-anchor='middle' x='128' y='260' fill='currentColor' style='font-size:1em'>f&lt;/text>
&lt;text text-anchor='middle' x='136' y='260' fill='currentColor' style='font-size:1em'>a&lt;/text>
&lt;text text-anchor='middle' x='144' y='196' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='144' y='260' fill='currentColor' style='font-size:1em'>l&lt;/text>
&lt;text text-anchor='middle' x='152' y='196' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='152' y='260' fill='currentColor' style='font-size:1em'>s&lt;/text>
&lt;text text-anchor='middle' x='160' y='196' fill='currentColor' style='font-size:1em'>m&lt;/text>
&lt;text text-anchor='middle' x='160' y='260' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='168' y='196' fill='currentColor' style='font-size:1em'>p&lt;/text>
&lt;text text-anchor='middle' x='176' y='196' fill='currentColor' style='font-size:1em'>,&lt;/text>
&lt;text text-anchor='middle' x='192' y='196' fill='currentColor' style='font-size:1em'>s&lt;/text>
&lt;text text-anchor='middle' x='200' y='196' fill='currentColor' style='font-size:1em'>e&lt;/text>
&lt;text text-anchor='middle' x='208' y='196' fill='currentColor' style='font-size:1em'>c&lt;/text>
&lt;text text-anchor='middle' x='216' y='196' fill='currentColor' style='font-size:1em'>t&lt;/text>
&lt;text text-anchor='middle' x='224' y='196' fill='currentColor' style='font-size:1em'>i&lt;/text>
&lt;text text-anchor='middle' x='232' y='196' fill='currentColor' style='font-size:1em'>o&lt;/text>
&lt;text text-anchor='middle' x='240' y='196' fill='currentColor' style='font-size:1em'>n&lt;/text>
&lt;text text-anchor='middle' x='304' y='180' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='312' y='180' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='320' y='180' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='328' y='180' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='336' y='180' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;text text-anchor='middle' x='344' y='180' fill='currentColor' style='font-size:1em'> &lt;/text>
&lt;/g>
&lt;/svg>
&lt;/div>
&lt;p>which when implemented gives us the following assembly code&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-riscvasm" data-lang="riscvasm">lock: #a0 - int* section
addi t0, zero, 1 #load 1 into t0
amoswap.w.aq t0, t0, (a0) #swap t0 =&amp;gt; (section) =&amp;gt; t0
bnez t0, lock #if t0 is not 0, try again
ret
unlock
amoswap.w.rl zero, zero, (a0)
ret
&lt;/code>&lt;/pre>&lt;p>The &lt;code>.w&lt;/code> in the instruction signifies that the swap is performed on a 32bit value (a Word).
There is also &lt;code>.d&lt;/code> that means that the swap is being performed on a 64b value (a Double word)&lt;/p>
&lt;p>The second thing we can se is the &lt;code>aq&lt;/code> and &lt;code>rl&lt;/code> flags. The &lt;code>aq&lt;/code> stands for &amp;ldquo;acquire constraint&amp;rdquo; and &lt;code>rq&lt;/code> stands for &amp;ldquo;release constraint&amp;rdquo;&lt;/p>
&lt;h2 id="memory-ordering-constraints">Memory ordering constraints&lt;/h2>
&lt;p>To understand what is being acomplished with the acquire and release constraints, we need to talk about the RISC-V memory model. RISC-V ISA specifies a relaxed memory model. This allows CPU architects to implement processors that execute instructions that access memory out of order. This increases performance, but leads to problems when making software.&lt;/p>
&lt;p>Let&amp;rsquo;s now assume that memory accesses can be reordered. Consider now these two lines of code:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//&amp;lt;- Other thread: head = head-&amp;gt;next;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">//&amp;lt;- Other thread: unlock(&amp;amp;section);
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">lock&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>section);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span> block &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>) head;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>lock&lt;/code> function executes the &lt;code>amoswap&lt;/code> we need to get exclusive access, and then we load value of &lt;code>head&lt;/code> into block. This seems correct, however when we take into consideration the fact that the CPU can execute instructions out of order, a possibility arises that the CPU will reorder the code to look something like:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span> block &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span>) head;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//&amp;lt;- Other thread: head = head-&amp;gt;next;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">//&amp;lt;- Other thread: unlock(&amp;amp;section);
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">lock&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>section);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This is now incorrect since the CPU loaded the &lt;code>head&lt;/code> of the list before locking the section, and possibly read a wrong value. This sort of reordering renders our lock function useless. To fix this problem the standard defines acquire and release constraints for all atomic instructions. If we attach an acquire constraint using &lt;code>.aq&lt;/code>, the CPU must not reorder any memory operations after the &lt;code>amoswap.w.aq&lt;/code> to execute before it, preventing the situation above.&lt;/p>
&lt;p>A simillar situation can arise if we consider:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>head &lt;span style="color:#f92672">=&lt;/span> head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">unlock&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>section);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//&amp;lt;-- Other thread: lock(&amp;amp;section);
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">//&amp;lt;-- Other thread: void* block = (void*) head;
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>getting reordered by the CPU to execute like:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">unlock&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>section);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//&amp;lt;-- Other thread: lock(&amp;amp;section);
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">//&amp;lt;-- Other thread: void* block = (void*) head;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>head &lt;span style="color:#f92672">=&lt;/span> head&lt;span style="color:#f92672">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Which could cause another thread to read the wrong value by storing the new &lt;code>head&lt;/code> too late. This problem is fixed by attaching a release constraint using &lt;code>.rl&lt;/code>, which prevents the CPU from reordering any memory operations before &lt;code>amoswap.w.rl&lt;/code> to execute after it. This prevents the store getting reordered past &lt;code>unlock&lt;/code>.&lt;/p>
&lt;h2 id="beware-of-interrupts">Beware of interrupts&lt;/h2>
&lt;p>Let&amp;rsquo;s now consider that we might need to allocate memory inside of the interrupt routine. Let&amp;rsquo;s say the interrupt handler looks like:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">interrupt&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">alloc_block&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We just introduced a bug, because the following can happen:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>TIME&lt;/th>
&lt;th>THREAD 1 (ON CORE 1)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1.&lt;/td>
&lt;td>alloc_block()&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2.&lt;/td>
&lt;td>-&amp;gt; lock(&amp;amp;section); // locks the section&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3.&lt;/td>
&lt;td>-&amp;gt; void* block = (void*) head;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4.&lt;/td>
&lt;td>-&amp;gt; //INTERRUPT TAKEN&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5.&lt;/td>
&lt;td>-&amp;gt; interrupt();&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>6.&lt;/td>
&lt;td>-&amp;gt; -&amp;gt; //&amp;hellip;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>7.&lt;/td>
&lt;td>-&amp;gt; -&amp;gt; alloc_block();&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>8.&lt;/td>
&lt;td>-&amp;gt; -&amp;gt; -&amp;gt; lock(&amp;amp;section); // &amp;lt;- infinite wait&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>The second call for lock will wait indefinetely, beacuse in the interrupt handler we are waiting for the lock to be unlocked, but it can&amp;rsquo;t get unlocked before the interrupt handler is finished. This situation is called a &lt;em>livelock&lt;/em>, because CPU will be executing what is effectively a while loop, forever.&lt;/p>
&lt;p>Now let&amp;rsquo;s fix this code. The obvious solution is to disable interrupts inside of the &lt;code>lock&lt;/code> function and enable them inside of the &lt;code>unlock&lt;/code> function. We will here assume that the kernel is running inside of Supervisor mode, and use the &lt;code>SIE&lt;/code> (Supervisor Interrupt Enable) bit of the &lt;code>sstatus&lt;/code> register to enable/disable interrupts.&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-riscvasm" data-lang="riscvasm">lock: #a0 - int* section
csrci sstatus, 2 #clear SIE - disable interrupts
lock_loop:
addi t0, zero, 1 #load 1 into t0
amoswap.w.aq t0, t0, (a0) #swap t0 =&amp;gt; (section) =&amp;gt; t0
bnez t0, lock_loop #if t0 is not 0, try again
ret
unlock
amoswap.w.rl zero, zero, (a0)
csrsi sstatus, 2 #set SIE - enable interrupts
ret
&lt;/code>&lt;/pre>&lt;p>The logic behind this solution is that we can delay taking the interrupt if we are inside a locked section, leaving the interrupt to be taken after we unlock the section, fixing the issue.&lt;/p>
&lt;p>This solution, however, can still cause problems.
The problem with this solution happens when we have nested critical sections. The problem is that after the &lt;code>unlock&lt;/code> in the nested section, the interrupts will be turned ON which leads to the livelock demonstrated above.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">lock&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>second_section);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">//Interrupt are OFF here
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">void&lt;/span>&lt;span style="color:#f92672">*&lt;/span> block &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">alloc_block&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">//Interrupts are ON here
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">unlock&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>second_section)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We will implement a fix for this solution, by counting how many times &lt;code>lock&lt;/code> was called, and remembering if interrupts were ON when &lt;code>lock&lt;/code> was initially called, and decreasing that number for every &lt;code>unlock&lt;/code>. Once that counter decreases to 0, we will enable interrupts if they were initially ON. For the sake of simplicity, we will be writing this version in C.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">typedef&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> depth
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> interrupts;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>} &lt;span style="color:#66d9ef">core_t&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">core_t&lt;/span> cores[CORE_COUNT];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">lock&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span> section)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> interrupts &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">intr_get&lt;/span>(); &lt;span style="color:#75715e">// check if interrupts are on
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">intr_off&lt;/span>(); &lt;span style="color:#75715e">// turn off interrutps
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">core_id&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">core_t&lt;/span>&lt;span style="color:#f92672">*&lt;/span> core &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>cores[id];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// save previous interrupt state for cpu on first lock
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span>(core&lt;span style="color:#f92672">-&amp;gt;&lt;/span>depth&lt;span style="color:#f92672">++&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> core&lt;span style="color:#f92672">-&amp;gt;&lt;/span>interrupts &lt;span style="color:#f92672">=&lt;/span> interrupts;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> val &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">amoswap_acquire&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>val, section);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span>(val);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">unlock&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span> section)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> id &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">core_id&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">core_t&lt;/span>&lt;span style="color:#f92672">*&lt;/span> core &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>cores[id];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> val &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">amoswap_release&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>val, section);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span>(&lt;span style="color:#f92672">--&lt;/span>core&lt;span style="color:#f92672">-&amp;gt;&lt;/span>depth &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> core&lt;span style="color:#f92672">-&amp;gt;&lt;/span>interrupts)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">intr_on&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The depth, and the interrupt state value is saved per CPU core, since all cores can be at different points of execution.&lt;/p>
&lt;h2 id="further-reading">Further reading&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://blog.regehr.org/archives/2173">A closer look at a spinlock (x86, ARM)&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://en.cppreference.com/w/cpp/atomic">Atomic builtins in C++&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://five-embeddev.com/riscv-isa-manual/latest/a.html#sec:amo">Atomic memory operations in RISC-V&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://five-embeddev.com/riscv-isa-manual/latest/a.html#specifying-ordering-of-atomic-instructions">Ordering constraints for atomic instructions in RISC-V&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://github.com/mit-pdos/xv6-riscv/blob/riscv/kernel/spinlock.c">xv6 spinlock implementation&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></content></item></channel></rss>